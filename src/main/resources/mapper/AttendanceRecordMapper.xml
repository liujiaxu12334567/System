<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.system.mapper.AttendanceRecordMapper">

    <resultMap id="AttendanceRecordMap" type="com.project.system.entity.AttendanceRecord">
        <id column="id" property="id"/>
        <result column="class_id" property="classId"/>
        <result column="course_id" property="courseId"/>
        <result column="student_id" property="studentId"/>
        <result column="date" property="date"/>
        <result column="present" property="present"/>
        <result column="batch_id" property="batchId"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <insert id="batchInsert">
        INSERT INTO attendance_record (class_id, course_id, student_id, date, present, batch_id, created_at)
        VALUES
        <foreach collection="records" item="r" separator=",">
            (#{r.classId}, #{r.courseId}, #{r.studentId}, #{r.date}, #{r.present}, #{r.batchId}, NOW())
        </foreach>
    </insert>

    <select id="selectByClassCourseStudent" resultMap="AttendanceRecordMap">
        SELECT id, class_id, course_id, student_id, date, present, batch_id, created_at
        FROM attendance_record
        WHERE class_id = #{classId}
        <if test="courseId != null">
            AND course_id = #{courseId}
        </if>
        <if test="studentId != null">
            AND student_id = #{studentId}
        </if>
        ORDER BY date ASC, id ASC
    </select>

    <select id="countByClassAndCourseIdsAndStudentIds" resultType="com.project.system.dto.StudentAttendanceAgg">
        SELECT
            student_id AS userId,
            SUM(CASE WHEN present = 1 THEN 1 ELSE 0 END) AS presentCount,
            COUNT(*) AS totalCount
        FROM attendance_record
        WHERE class_id = #{classId}
        <if test="courseIds != null and courseIds.size > 0">
            AND course_id IN
            <foreach collection="courseIds" item="cid" open="(" separator="," close=")">
                #{cid}
            </foreach>
        </if>
        <if test="studentIds != null and studentIds.size > 0">
            AND student_id IN
            <foreach collection="studentIds" item="sid" open="(" separator="," close=")">
                #{sid}
            </foreach>
        </if>
        GROUP BY student_id
    </select>
</mapper>
